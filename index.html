<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maliyakkal Family Tree</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Neo4j JavaScript Driver -->
    <script src="https://unpkg.com/neo4j-driver"></script>
    <style>
        /* Simple transition for modals and buttons */
        .modal {
            transition: opacity 0.25s ease;
        }
        .btn {
            @apply px-4 py-2 rounded-md font-semibold text-white shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400;
        }
        .btn-disabled {
            @apply bg-gray-300 cursor-not-allowed hover:scale-100;
        }
        /* Styles for the responsive table-to-card view */
        @media (max-width: 640px) {
            #person-list td:before {
                content: attr(data-label);
                font-weight: 600; /* semibold */
                width: 7rem; /* 112px */
                flex-shrink: 0; /* Prevent label from shrinking */
                display: inline-block;
                color: #4b5563; /* gray-600 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="container mx-auto p-2 sm:p-4 max-w-7xl">

        <!-- Connection Screen -->
        <div id="connection-screen" class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Connect to Neo4j Database</h1>
                <div class="space-y-4">
                    <div>
                        <label for="uri" class="block text-sm font-medium text-gray-700">Database URI</label>
                        <input type="text" id="uri" value="neo4j+s://51ac777b.databases.neo4j.io" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="connect-btn" class="w-full btn btn-primary">Connect</button>
                </div>
            </div>
        </div>

        <!-- Main Application Screen (hidden by default) -->
        <div id="main-app" class="hidden">
            <header class="bg-white p-4 rounded-lg shadow-md mb-4 flex flex-wrap items-center justify-between gap-2">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Maliyakkal Family Tree</h1>
                <button id="enter-edit-mode-btn" class="btn btn-primary ml-auto">Enter Edit Mode</button>
                <p id="current-selection-label" class="text-gray-600 italic mt-1 w-full">Current Selection: None</p>
            </header>
            
            <!-- Search Bar -->
            <div class="relative mb-4">
                <input type="text" id="search-input" placeholder="Search for a person..." class="w-full p-3 rounded-lg shadow-md border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-200 rounded-b-lg shadow-lg mt-1 hidden"></div>
            </div>


            <!-- Action Buttons -->
            <div class="bg-white p-3 rounded-lg shadow-md mb-4 flex flex-col sm:flex-row flex-wrap items-center gap-y-2">
                <!-- Primary Actions -->
                <div class="flex flex-row flex-wrap justify-center items-center">
                    <button id="add-child-btn" class="btn btn-primary btn-disabled mx-1" disabled>Add Child</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="add-sibling-btn" class="btn btn-primary btn-disabled mx-1" disabled>Add Sibling</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="add-spouse-btn" class="btn btn-primary btn-disabled mx-1" disabled>Add Spouse</button>
                </div>

                <!-- Contextual Actions -->
                <div class="flex flex-row flex-wrap justify-center items-center w-full sm:w-auto border-t sm:border-t-0 sm:border-l border-gray-200 pt-2 sm:pt-0 sm:pl-4">
                    <button id="modify-btn" class="btn btn-secondary btn-disabled mx-1" disabled>Modify Person</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="view-children-btn" class="btn btn-secondary btn-disabled mx-1" disabled>View Children</button>
                </div>

                <!-- Spacer -->
                <div class="flex-grow"></div>

                <!-- Navigation Actions -->
                <div class="flex flex-row flex-wrap justify-center items-center w-full sm:w-auto border-t sm:border-t-0 sm:border-l border-gray-200 pt-2 sm:pt-0 sm:pl-4">
                    <button id="back-btn" class="btn btn-secondary btn-disabled mx-1" disabled>Go Back</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="top-gen-btn" class="btn btn-secondary mx-1">Go to Top Generation</button>
                </div>
            </div>

            <!-- Person List -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="min-w-full">
                    <thead id="person-list-header" class="bg-gray-50 hidden sm:table-header-group">
                        <!-- Header generated by JS -->
                    </thead>
                    <tbody id="person-list" class="bg-white">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Modal for Forms -->
    <div id="modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="opacity: 0;">
        <div class="relative top-10 sm:top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Add Person</h3>
                <div id="modal-form" class="mt-2 px-7 py-3 space-y-4 text-left">
                    <!-- Form fields will be inserted here by JavaScript -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-submit" class="btn btn-primary">Submit</button>
                    <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Details View -->
    <div id="details-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="opacity: 0;">
        <div class="relative top-10 sm:top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="details-modal-title" class="text-xl text-center leading-6 font-bold text-gray-900">Person Details</h3>
                <div id="details-modal-content" class="mt-4 px-7 py-3 text-base text-left">
                    <!-- Details will be inserted here by JavaScript -->
                </div>
                <div class="items-center px-4 py-3 sm:flex">
                    <button id="details-modal-view-children" class="btn btn-primary w-full sm:w-auto mb-2 sm:mb-0 sm:mr-2">View Children</button>
                    <div class="flex-grow"></div>
                    <button id="details-modal-close" class="btn btn-secondary w-full sm:w-auto mb-2 sm:mb-0 sm:mr-2">Close</button>
                    <button id="details-modal-modify" class="btn btn-primary w-full sm:w-auto">Modify Person</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const App = {
            driver: null,
            dbName: 'neo4j', // AuraDB default
            currentPersonId: null,
            editModeEnabled: false, // State to track edit mode
            
            // --- State management for refreshing the view ---
            viewMode: 'generation',
            viewContextId: 1,
            viewHistory: [],
            
            // --- Initialization ---
            init() {
                this.cacheElements();
                this.bindEvents();
                this.toggleEditMode(false); // Set initial state to disabled
            },

            cacheElements() {
                this.ui = {
                    connectionScreen: document.getElementById('connection-screen'),
                    mainApp: document.getElementById('main-app'),
                    uriInput: document.getElementById('uri'),
                    passwordInput: document.getElementById('password'),
                    connectBtn: document.getElementById('connect-btn'),
                    selectionLabel: document.getElementById('current-selection-label'),
                    personList: document.getElementById('person-list'),
                    personListHeader: document.getElementById('person-list-header'),
                    searchInput: document.getElementById('search-input'),
                    searchResults: document.getElementById('search-results'),
                    buttons: {
                        addChild: document.getElementById('add-child-btn'),
                        addSibling: document.getElementById('add-sibling-btn'),
                        addSpouse: document.getElementById('add-spouse-btn'),
                        modify: document.getElementById('modify-btn'),
                        viewChildren: document.getElementById('view-children-btn'),
                        back: document.getElementById('back-btn'),
                        topGen: document.getElementById('top-gen-btn'),
                        enterEditMode: document.getElementById('enter-edit-mode-btn'),
                    },
                    modal: {
                        container: document.getElementById('modal'),
                        title: document.getElementById('modal-title'),
                        form: document.getElementById('modal-form'),
                        submit: document.getElementById('modal-submit'),
                        cancel: document.getElementById('modal-cancel'),
                    },
                    detailsModal: {
                        container: document.getElementById('details-modal'),
                        title: document.getElementById('details-modal-title'),
                        content: document.getElementById('details-modal-content'),
                        close: document.getElementById('details-modal-close'),
                        modify: document.getElementById('details-modal-modify'),
                        viewChildren: document.getElementById('details-modal-view-children'),
                    }
                };
            },

            bindEvents() {
                this.ui.connectBtn.addEventListener('click', () => this.connect());
                this.ui.passwordInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.connect();
                });
                
                // Main app buttons
                this.ui.buttons.topGen.addEventListener('click', () => this.go_to_top_generation());
                this.ui.buttons.back.addEventListener('click', () => this.goBack());
                this.ui.buttons.viewChildren.addEventListener('click', () => this.viewChildren());

                // Action buttons that depend on selection
                this.ui.buttons.addChild.addEventListener('click', () => this.addChild());
                this.ui.buttons.addSibling.addEventListener('click', () => this.addSibling());
                this.ui.buttons.addSpouse.addEventListener('click', () => this.addSpouse());
                this.ui.buttons.modify.addEventListener('click', () => this.modifyPerson());
                
                // Edit Mode toggle button event
                this.ui.buttons.enterEditMode.addEventListener('click', () => this.handleEditModeToggle());

                // Search
                this.ui.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                
                // Event Delegation for inline editing
                this.ui.personList.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    const container = e.target.closest('[data-person-id]');
                    const personId = container.dataset.personId;
                    const input = container.querySelector(`[data-action-input="${action.split('-')[1]}"]`);
                    const originalValue = container.dataset.originalValue;
                    const editBtn = container.querySelector(`[data-action="edit-${action.split('-')[1]}"]`);
                    const saveBtn = container.querySelector(`[data-action="save-${action.split('-')[1]}"]`);
                    const cancelBtn = container.querySelector(`[data-action="cancel-${action.split('-')[1]}"]`);

                    // Only allow inline editing if edit mode is enabled
                    if (!this.editModeEnabled) {
                        alert("Please enter Edit Mode to make changes.");
                        return;
                    }

                    if (action.startsWith('edit-')) {
                        input.disabled = false;
                        input.classList.remove('bg-gray-100');
                        input.focus();
                        editBtn.classList.add('hidden');
                        saveBtn.classList.remove('hidden');
                        cancelBtn.classList.remove('hidden');
                    } else if (action.startsWith('cancel-')) {
                        input.value = originalValue;
                        input.disabled = true;
                        input.classList.add('bg-gray-100');
                        editBtn.classList.remove('hidden');
                        saveBtn.classList.add('hidden');
                        cancelBtn.classList.add('hidden');
                    } else if (action.startsWith('save-')) {
                        const property = action.split('-')[1];
                        if (property === 'cn') {
                               this.saveChildNumber(personId, input.value, originalValue);
                        } else {
                            this.saveProperty(personId, property, input.value);
                        }
                    }
                });

                // Event delegation for dynamic links in the header
                this.ui.selectionLabel.addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-parents-link')) {
                        e.preventDefault();
                        const parentId = e.target.dataset.parentId;
                        this._loadView('children', parentId, true);
                    }
                });

                // Details Modal Events
                this.ui.detailsModal.close.addEventListener('click', () => this.closeDetailsModal());
                this.ui.detailsModal.modify.addEventListener('click', () => {
                    // Check edit mode before allowing modify from details modal
                    if (!this.editModeEnabled) {
                        alert("Please enter Edit Mode to modify persons.");
                        return;
                    }
                    this.closeDetailsModal();
                    this.modifyPerson(); 
                });
                this.ui.detailsModal.viewChildren.addEventListener('click', () => {
                    this.closeDetailsModal();
                    this.viewChildren(); 
                });
            },

            // Handles toggling edit mode on/off
            handleEditModeToggle() {
                if (this.editModeEnabled) {
                    // Currently in edit mode, so exit it
                    this.toggleEditMode(false);
                    alert("Edit mode disabled.");
                } else {
                    // Not in edit mode, prompt for password to enter
                    const password = prompt("Enter password to enable edit mode:");
                    if (password === "Maliyakkal") {
                        this.toggleEditMode(true);
                        alert("Edit mode enabled!");
                    } else if (password !== null) { // null if user clicked cancel
                        alert("Incorrect password.");
                    }
                }
            },

            // Controls the enabled/disabled state of edit buttons and updates the toggle button text
            toggleEditMode(enable) {
                this.editModeEnabled = enable;
                const editableButtons = [
                    this.ui.buttons.addChild,
                    this.ui.buttons.addSibling,
                    this.ui.buttons.addSpouse,
                    this.ui.buttons.modify,
                    this.ui.detailsModal.modify // Modify button in details modal
                ];

                editableButtons.forEach(btn => {
                    if (btn) { // Ensure the button element exists
                        btn.disabled = !enable;
                        btn.classList.toggle('btn-disabled', !enable);
                    }
                });

                // Update the text of the main edit mode toggle button
                if (this.ui.buttons.enterEditMode) {
                    this.ui.buttons.enterEditMode.textContent = enable ? "Exit Edit Mode" : "Enter Edit Mode";
                    // Change button color based on state (optional, but good UX)
                    this.ui.buttons.enterEditMode.classList.toggle('bg-red-600', enable);
                    this.ui.buttons.enterEditMode.classList.toggle('hover:bg-red-700', enable);
                    this.ui.buttons.enterEditMode.classList.toggle('focus:ring-red-500', enable);
                    this.ui.buttons.enterEditMode.classList.toggle('bg-blue-600', !enable);
                    this.ui.buttons.enterEditMode.classList.toggle('hover:bg-blue-700', !enable);
                    this.ui.buttons.enterEditMode.classList.toggle('focus:ring-blue-500', !enable);
                }


                // After changing edit mode, re-evaluate the selection-dependent buttons
                // This ensures "Add Child", etc. are only enabled if both editMode is on AND a person is selected.
                if (this.currentPersonId) {
                    this.onPersonSelect(this.currentPersonId, this.ui.selectionLabel.textContent);
                } else {
                    this.resetButtons(); // This will disable all action buttons if nothing is selected
                }
            },

            // --- Connection Logic ---
            async connect() {
                const uri = this.ui.uriInput.value;
                const password = this.ui.passwordInput.value;
                const user = 'neo4j';

                if (!uri || !password) {
                    alert('Please provide both URI and password.');
                    return;
                }

                this.ui.connectBtn.textContent = 'Connecting...';
                this.ui.connectBtn.disabled = true;

                try {
                    this.driver = neo4j.driver(uri, neo4j.auth.basic(user, password));
                    await this.driver.verifyConnectivity();
                    
                    this.ui.connectionScreen.classList.add('hidden');
                    this.ui.mainApp.classList.remove('hidden');
                    this.go_to_top_generation();

                } catch (error) {
                    console.error('Connection Error:', error);
                    alert(`Connection failed: ${error.message}`);
                } finally {
                    this.ui.connectBtn.textContent = 'Connect';
                    this.ui.connectBtn.disabled = false;
                }
            },

            // --- Data Fetching & Display ---
            async runQuery(query, params = {}) {
                if (!this.driver) return [];
                const session = this.driver.session({ database: this.dbName });
                try {
                    const result = await session.run(query, params);
                    return result.records.map(record => record.toObject());
                } catch (error) {
                    console.error('Query Error:', error);
                    alert(`A database error occurred: ${error.message}`);
                    return [];
                } finally {
                    await session.close();
                }
            },
            
            // --- View Loading Logic ---
            async _loadView(mode, contextId, addToHistory) {
                if (addToHistory) {
                    this.viewHistory.push({ mode: this.viewMode, contextId: this.viewContextId });
                }

                this.viewMode = mode;
                this.viewContextId = contextId;

                if (mode === 'children') {
                    await this._displayChildrenInternal(contextId);
                } else {
                    await this._displayTopGenInternal();
                }

                this.ui.buttons.back.disabled = this.viewHistory.length === 0;
            },

            async _displayTopGenInternal() {
                const query = `
                    CALL {
                        MATCH (p:Person) WHERE toInteger(p.genNumber) = 1
                        OPTIONAL MATCH (p)-[:SPOUSE_OF]-(s:Person) WHERE toInteger(s.genNumber) = 1
                        WITH p, s WHERE s IS NULL OR id(p) < id(s)
                        RETURN p as person, '' as indicator, p.id as sortKey, 0 as isSpouse, p.childNumber as childNumber
                        UNION
                        MATCH (p:Person)-[:SPOUSE_OF]-(s:Person) WHERE toInteger(p.genNumber) = 1 AND toInteger(s.genNumber) = 1 AND id(p) > id(s)
                        RETURN p as person, '(Spouse of ' + s.firstName + ')' as indicator, s.id as sortKey, 1 as isSpouse, null as childNumber
                    }
                    RETURN person.id as id,
                            trim(coalesce(person.firstName, '') + ' ' + coalesce(person.lastName, '')) AS name,
                            coalesce(person.dob, 'Not Set') AS dob,
                            coalesce(person.dod, 'N/A') AS dod,
                            indicator,
                            childNumber
                    ORDER BY sortKey, isSpouse
                `;
                const people = await this.runQuery(query);
                this.renderPersonList(people, 'Displaying Top Generation');
            },

            async _displayChildrenInternal(parentId) {
                const parentInfoResult = await this.runQuery('MATCH (p:Person {id: $id}) OPTIONAL MATCH (p)-[:CHILD_OF]->(gp:Person) RETURN p.firstName as firstName, p.lastName as lastName, collect({id: gp.id, name: trim(coalesce(gp.firstName, "") + " " + coalesce(gp.lastName, ""))}) as grandParents', { id: parentId });
                const parentInfo = parentInfoResult.length > 0 ? parentInfoResult[0] : { firstName: parentId, lastName: '', grandParents: [] };
                const parentName = `${parentInfo.firstName || ''} ${parentInfo.lastName || ''}`.trim();
                
                let labelHTML = `Children of: ${parentName}`;
                if (parentInfo.grandParents && parentInfo.grandParents.length > 0 && parentInfo.grandParents[0].id) {
                    const gpLinks = parentInfo.grandParents.map(gp => `<a href="#" data-parent-id="${gp.id}" class="text-blue-500 hover:underline view-parents-link">${gp.name}</a>`).join(', ');
                    labelHTML += ` <span class="text-sm">(Parents: ${gpLinks})</span>`;
                }
                
                const query = `
                    CALL {
                        MATCH (parent:Person {id: $parentId})<-[:CHILD_OF]-(child:Person)
                        RETURN child AS person, '' AS indicator, child.id AS sortKey, 0 as isSpouse, null as parentId, child.childNumber as childNumber
                        UNION
                        MATCH (parent:Person {id: $parentId})<-[:CHILD_OF]-(child:Person)-[:SPOUSE_OF]-(spouse:Person)
                        WHERE NOT (spouse)-[:CHILD_OF]->(parent)
                        WITH DISTINCT spouse, child
                        OPTIONAL MATCH (spouse)-[:CHILD_OF]->(spouseParent:Person)
                        WITH spouse, child, collect(spouseParent.id)[0] as firstParentId
                        RETURN spouse AS person, '(Spouse of ' + child.firstName + ')' AS indicator, child.id AS sortKey, 1 as isSpouse, firstParentId as parentId, null as childNumber
                    }
                    RETURN person.id as id,
                            trim(coalesce(person.firstName, '') + ' ' + coalesce(person.lastName, '')) AS name,
                            coalesce(person.dob, 'Not Set') AS dob,
                            coalesce(person.dod, 'N/A') AS dod,
                            indicator,
                            parentId,
                            childNumber
                    ORDER BY sortKey, isSpouse
                `;
                const childrenAndSpouses = await this.runQuery(query, { parentId });
                this.renderPersonList(childrenAndSpouses, labelHTML);
            },

            renderPersonList(people, label) {
                this.ui.personList.innerHTML = '';
                this.resetButtons(); // Reset buttons first
                
                if (label) {
                    this.ui.selectionLabel.innerHTML = label;
                }

                // Update table header based on view mode
                this.ui.personListHeader.innerHTML = `
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Child #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOD</th>
                    </tr>
                `;

                if (people.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" class="block sm:table-cell px-6 py-4 text-center text-gray-500">No people found.</td>`;
                    this.ui.personList.appendChild(row);
                } else {
                    people.forEach(person => {
                        const row = document.createElement('tr');
                        row.className = 'block sm:table-row border-b sm:border-none mb-2 sm:mb-0 cursor-pointer hover:bg-gray-50';
                        
                        let indicatorHTML = '';
                        let childNumberContent = '';
                        let childNumberDataLabel = 'Child #:';

                        if (person.indicator) { // It's a spouse
                            childNumberDataLabel = ''; // Hide label on mobile
                            if (person.parentId) {
                                indicatorHTML = `<span class="text-xs text-gray-400 italic ml-2">${person.indicator} <a href="#" data-parent-id="${person.parentId}" class="text-blue-500 hover:underline view-parents-link">${person.parentId}</a></span>`;
                            } else {
                                indicatorHTML = `<span class="text-xs text-gray-400 italic ml-2">${person.indicator}</span>`;
                            }
                            // On mobile, this will be the only content in the childNumber cell
                            childNumberContent = `<div class="sm:hidden">${indicatorHTML}</div>`; 
                        } else { // It's a main person/child
                            const cnValue = person.childNumber;
                            const childNum = (typeof cnValue === 'object' && cnValue !== null && cnValue.low !== undefined) ? cnValue.low : cnValue;
                            const displayNum = (childNum === null || childNum === undefined) ? '' : childNum;

                            childNumberContent = `
                                <div class="flex items-center gap-1" data-person-id="${person.id}" data-original-value="${displayNum}">
                                    <input type="number" value="${displayNum}" class="w-16 p-1 border rounded-md bg-gray-100" disabled data-action-input="cn">
                                    <button class="text-xs text-blue-500 hover:underline" data-action="edit-cn">Edit</button>
                                    <button class="text-xs text-green-500 hover:underline hidden" data-action="save-cn">Save</button>
                                    <button class="text-xs text-red-500 hover:underline hidden" data-action="cancel-cn">Cancel</button>
                                </div>
                            `;
                        }

                        const dobHTML = `
                            <div class="flex items-center gap-1" data-person-id="${person.id}" data-original-value="${person.dob}">
                                <input type="text" value="${person.dob}" class="w-28 p-1 border rounded-md bg-gray-100" disabled data-action-input="dob">
                                <button class="text-xs text-blue-500 hover:underline" data-action="edit-dob">Edit</button>
                                <button class="text-xs text-green-500 hover:underline hidden" data-action="save-dob">Save</button>
                                <button class="text-xs text-red-500 hover:underline hidden" data-action="cancel-dob">Cancel</button>
                            </div>
                        `;
                        const dodHTML = `
                            <div class="flex items-center gap-1" data-person-id="${person.id}" data-original-value="${person.dod}">
                                <input type="text" value="${person.dod}" class="w-28 p-1 border rounded-md bg-gray-100" disabled data-action-input="dod">
                                <button class="text-xs text-blue-500 hover:underline" data-action="edit-dod">Edit</button>
                                <button class="text-xs text-green-500 hover:underline hidden" data-action="save-dod">Save</button>
                                <button class="text-xs text-red-500 hover:underline hidden" data-action="cancel-dod">Cancel</button>
                            </div>
                        `;


                        row.innerHTML = `
                            <td data-label="ID:" class="flex items-center sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-sm font-medium text-gray-700">${person.id}</td>
                            <td data-label="Name:" class="flex items-center sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-lg font-semibold text-gray-800">${person.name} <span class="hidden sm:inline">${indicatorHTML}</span></td>
                            <td data-label="${childNumberDataLabel}" class="flex items-center sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-base text-gray-500">${childNumberContent}</td>
                            <td data-label="DOB:" class="flex items-center sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-base text-gray-500">${dobHTML}</td>
                            <td data-label="DOD:" class="flex items-center sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-base text-gray-500">${dodHTML}</td>
                        `;
                        row.addEventListener('click', (e) => {
                            if (e.target.classList.contains('view-parents-link')) {
                                e.stopPropagation();
                                const parentId = e.target.dataset.parentId;
                                this._loadView('children', parentId, true);
                                return;
                            }
                            document.querySelectorAll('#person-list tr').forEach(r => r.classList.remove('bg-blue-100'));
                            row.classList.add('bg-blue-100');
                            this.onPersonSelect(person.id, person.name);
                        });
                        row.addEventListener('dblclick', (e) => {
                               if (!e.target.classList.contains('view-parents-link')) {
                                   this.viewChildren();
                                 }
                        });
                        this.ui.personList.appendChild(row);
                    });
                }

                if (this.viewMode === 'children') {
                    this.currentPersonId = this.viewContextId; // Set active person to the parent
                    // These buttons are always enabled if a person is selected AND edit mode is ON
                    this.ui.buttons.addChild.disabled = !this.editModeEnabled;
                    this.ui.buttons.addChild.classList.toggle('btn-disabled', !this.editModeEnabled);
                    this.ui.buttons.addSpouse.disabled = !this.editModeEnabled;
                    this.ui.buttons.addSpouse.classList.toggle('btn-disabled', !this.editModeEnabled);
                    this.ui.selectionLabel.innerHTML += `<span class="italic text-gray-500">. Actions apply to parent.</span>`;
                }
            },

            // --- UI State & Event Handlers ---
            onPersonSelect(id, name) {
                this.currentPersonId = id;
                this.ui.selectionLabel.textContent = `Selected: ${name} (ID: ${id})`;
                
                // Always enable view buttons when a person is selected
                this.ui.buttons.viewChildren.disabled = false;
                this.ui.buttons.viewChildren.classList.remove('btn-disabled');
                
                // Only enable modification buttons if edit mode is active
                if (this.editModeEnabled) {
                    this.ui.buttons.addChild.disabled = false;
                    this.ui.buttons.addChild.classList.remove('btn-disabled');
                    this.ui.buttons.addSibling.disabled = false;
                    this.ui.buttons.addSibling.classList.remove('btn-disabled');
                    this.ui.buttons.addSpouse.disabled = false;
                    this.ui.buttons.addSpouse.classList.remove('btn-disabled');
                    this.ui.buttons.modify.disabled = false;
                    this.ui.buttons.modify.classList.remove('btn-disabled');
                } else {
                    // Ensure modification buttons are disabled if not in edit mode
                    this.ui.buttons.addChild.disabled = true;
                    this.ui.buttons.addChild.classList.add('btn-disabled');
                    this.ui.buttons.addSibling.disabled = true;
                    this.ui.buttons.addSibling.classList.add('btn-disabled');
                    this.ui.buttons.addSpouse.disabled = true;
                    this.ui.buttons.addSpouse.classList.add('btn-disabled');
                    this.ui.buttons.modify.disabled = true;
                    this.ui.buttons.modify.classList.add('btn-disabled');
                }
            },

            resetButtons() {
                this.currentPersonId = null;
                this.ui.selectionLabel.textContent = 'Current Selection: None';
                
                // Disable all action buttons when nothing is selected
                const allActionButtons = [
                    this.ui.buttons.addChild,
                    this.ui.buttons.addSibling,
                    this.ui.buttons.addSpouse,
                    this.ui.buttons.modify,
                    this.ui.buttons.viewChildren // View Children also disabled when no person selected
                ];
                allActionButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('btn-disabled');
                });
                // Also ensure the modify button in details modal is disabled
                if (this.ui.detailsModal.modify) {
                    this.ui.detailsModal.modify.disabled = true;
                    this.ui.detailsModal.modify.classList.add('btn-disabled');
                }
            },
            
            async goBack() {
                if (this.viewHistory.length === 0) return;
                const previousView = this.viewHistory.pop();
                await this._loadView(previousView.mode, previousView.contextId, false);
            },
            
            go_to_top_generation() {
                this.viewHistory = [];
                this._loadView('generation', 1, false);
            },
            
            viewChildren() {
                if (!this.currentPersonId) return;
                this._loadView('children', this.currentPersonId, true);
            },

            // --- Search Logic ---
            async handleSearch(searchText) {
                if (searchText.length < 2) {
                    this.ui.searchResults.innerHTML = '';
                    this.ui.searchResults.classList.add('hidden');
                    return;
                }
                const query = `
                    MATCH (p:Person)
                    WHERE toLower(coalesce(p.firstName, '') + ' ' + coalesce(p.lastName, '')) CONTAINS toLower($searchText)
                    RETURN p.id as id, p.firstName as firstName, p.lastName as lastName
                    LIMIT 10
                `;
                const results = await this.runQuery(query, { searchText });
                this.renderSearchResults(results);
            },

            renderSearchResults(results) {
                this.ui.searchResults.innerHTML = '';
                if (results.length === 0) {
                    this.ui.searchResults.classList.add('hidden');
                    return;
                }
                
                results.forEach(person => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-blue-100 cursor-pointer';
                    div.textContent = `${person.firstName || ''} ${person.lastName || ''} (${person.id})`;
                    div.addEventListener('click', () => {
                        this.showDetails(person.id);
                        this.ui.searchInput.value = '';
                        this.ui.searchResults.classList.add('hidden');
                    });
                    this.ui.searchResults.appendChild(div);
                });
                this.ui.searchResults.classList.remove('hidden');
            },

            // --- Details Modal Logic ---
            async showDetails(personId) {
                const query = `
                    MATCH (p:Person {id: $personId})
                    OPTIONAL MATCH (p)-[:SPOUSE_OF]-(s:Person)
                    OPTIONAL MATCH (p)-[:CHILD_OF]->(parent:Person)
                    OPTIONAL MATCH (p)<-[:CHILD_OF]-(child:Person)
                    RETURN p, 
                           collect(DISTINCT {id: s.id, name: s.firstName + ' ' + s.lastName}) AS spouses,
                           collect(DISTINCT {id: parent.id, name: parent.firstName + ' ' + parent.lastName}) AS parents,
                           collect(DISTINCT {id: child.id, name: child.firstName + ' ' + child.lastName}) AS children
                `;
                const result = await this.runQuery(query, { personId });

                if (result.length === 0) {
                    alert('Person details not found.');
                    return;
                }

                const personData = result[0].p.properties;
                const spouses = result[0].spouses.filter(s => s.id); // Filter out nulls/empty
                const parents = result[0].parents.filter(p => p.id);
                const children = result[0].children.filter(c => c.id);

                let detailsHtml = `
                    <p class="mb-2"><strong>ID:</strong> ${personData.id || 'N/A'}</p>
                    <p class="mb-2"><strong>First Name:</strong> ${personData.firstName || 'N/A'}</p>
                    <p class="mb-2"><strong>Last Name:</strong> ${personData.lastName || 'N/A'}</p>
                    <p class="mb-2"><strong>Gender:</strong> ${personData.gender || 'N/A'}</p>
                    <p class="mb-2"><strong>Date of Birth:</strong> ${personData.dob || 'N/A'}</p>
                    <p class="mb-2"><strong>Date of Death:</strong> ${personData.dod || 'N/A'}</p>
                    <p class="mb-2"><strong>Generation Number:</strong> ${personData.genNumber ? (typeof personData.genNumber === 'object' ? personData.genNumber.low : personData.genNumber) : 'N/A'}</p>
                    <p class="mb-2"><strong>Child Number:</strong> ${personData.childNumber ? (typeof personData.childNumber === 'object' ? personData.childNumber.low : personData.childNumber) : 'N/A'}</p>
                `;

                // Add other dynamic properties
                for (const key in personData) {
                    if (!['id', 'firstName', 'lastName', 'gender', 'dob', 'dod', 'genNumber', 'childNumber'].includes(key)) {
                        detailsHtml += `<p class="mb-2"><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> ${personData[key] || 'N/A'}</p>`;
                    }
                }

                detailsHtml += `<div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="mb-2"><strong>Parents:</strong> ${parents.map(p => p.name).join(', ') || 'None'}</p>
                    <p class="mb-2"><strong>Spouses:</strong> ${spouses.map(s => s.name).join(', ') || 'None'}</p>
                    <p class="mb-2"><strong>Children:</strong> ${children.map(c => c.name).join(', ') || 'None'}</p>
                </div>`;

                this.ui.detailsModal.content.innerHTML = detailsHtml;
                this.ui.detailsModal.title.textContent = `Details for ${personData.firstName || ''} ${personData.lastName || ''}`;
                this.currentPersonId = personId; // Set currentPersonId for modify/view children action from modal

                // The "View Children" button should always be enabled here
                this.ui.detailsModal.viewChildren.disabled = false;
                this.ui.detailsModal.viewChildren.classList.remove('btn-disabled');

                // The "Modify Person" button in the details modal should respect the editModeEnabled state
                this.ui.detailsModal.modify.disabled = !this.editModeEnabled;
                this.ui.detailsModal.modify.classList.toggle('btn-disabled', !this.editModeEnabled);

                this.ui.detailsModal.container.classList.remove('hidden');
                setTimeout(() => this.ui.detailsModal.container.style.opacity = 1, 10);
            },

            closeDetailsModal() {
                this.ui.modal.container.style.opacity = 0;
                setTimeout(() => this.ui.modal.container.classList.add('hidden'), 250);
            },

            // --- Actions (Add, Modify, etc.) ---
            async addChild() {
                // Check edit mode
                if (!this.editModeEnabled) { alert("Please enter Edit Mode to add children."); return; }
                if (!this.currentPersonId) return;
                const parent = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.genNumber as gen', { id: this.currentPersonId }))[0];
                const parentGen = parent ? parseInt(parent.gen, 10) : 1;
                
                const spouses = await this.runQuery('MATCH (p:Person {id: $id})-[:SPOUSE_OF]-(s:Person) RETURN s.id as id, s.firstName as name', { id: this.currentPersonId });

                this.openForm({
                    type: 'child',
                    relatedId: this.currentPersonId,
                    genNumber: parentGen + 1,
                    title: 'Add New Child',
                    context: { spouses }
                });
            },
            
            async addSibling() {
                // Check edit mode
                if (!this.editModeEnabled) { alert("Please enter Edit Mode to add siblings."); return; }
                if (!this.currentPersonId) return;
                const sibling = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.genNumber as gen', { id: this.currentPersonId }))[0];
                if (!sibling) {
                    alert("Cannot add sibling to a person with no generation number.");
                    return;
                }
                this.openForm({
                    type: 'sibling',
                    relatedId: this.currentPersonId,
                    genNumber: parseInt(sibling.gen, 10),
                    title: 'Add New Sibling'
                });
            },
            
            async addSpouse() {
                // Check edit mode
                if (!this.editModeEnabled) { alert("Please enter Edit Mode to add spouses."); return; }
                if (!this.currentPersonId) return;
                const person = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.genNumber as gen', { id: this.currentPersonId }))[0];
                const personGen = person ? parseInt(person.gen, 10) : 1;
                this.openForm({
                    type: 'spouse',
                    relatedId: this.currentPersonId,
                    genNumber: personGen,
                    title: 'Add New Spouse'
                });
            },

            async modifyPerson() {
                // Check edit mode
                if (!this.editModeEnabled) { alert("Please enter Edit Mode to modify persons."); return; }
                if (!this.currentPersonId) {
                    alert("Please select a person to modify or use the search results 'Modify Person' button.");
                    return;
                }
                const personDataResult = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p', { id: this.currentPersonId }))[0];
                const personData = personDataResult.p.properties;

                const parentsResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN collect({id: p.id, name: trim(coalesce(p.firstName, "") + " " + coalesce(p.lastName, ""))}) as parents', { id: this.currentPersonId });
                const parentsInfo = parentsResult.length > 0 ? parentsResult[0].parents : [];
                
                personData.parents = parentsInfo.map(p => p.id);
                personData.parentNames = parentsInfo.map(p => p.name);

                this.openForm({
                    type: 'modify',
                    relatedId: this.currentPersonId,
                    initialData: personData,
                    title: 'Modify Person'
                });
            },
            
            async saveChildNumber(oldId, newChildNumberStr, originalValueStr) {
                // This is called from inline edit, which already has edit mode check in bindEvents
                const newChildNumber = parseInt(newChildNumberStr, 10);
                if (isNaN(newChildNumber)) {
                    alert('Child Number must be a number.');
                    this.refreshCurrentView();
                    return;
                }
                
                const parentResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id LIMIT 1', { id: oldId });
                const parentId = (parentResult.length > 0) ? parentResult[0].id : oldId.substring(0, oldId.lastIndexOf('_'));


                if (!parentId) {
                    alert('Could not determine parent for this person. ID cannot be updated.');
                    this.refreshCurrentView();
                    return;
                }
                const newId = `${parentId}_${newChildNumber}`;

                if (newId === oldId) {
                    this.refreshCurrentView();
                    return; // No change needed
                }

                const conflict = await this.runQuery('MATCH (p:Person {id: $id}) RETURN p', { id: newId });
                if (conflict.length > 0) {
                    alert(`Error: A person with the new generated ID '${newId}' already exists. Please choose a different childNumber.`);
                    return;
                }
                
                // Recursive update query
                const updateQuery = `
                    MATCH (p:Person {id: $oldId})
                    SET p.id = $newId, p.childNumber = $newChildNumber
                    WITH p, $oldId AS oldIdBase, $newId AS newIdBase
                    CALL {
                        WITH p
                        MATCH (p)<-[:CHILD_OF*]-(descendant:Person)
                        RETURN collect(descendant) AS descendants
                    }
                    UNWIND descendants AS d
                    SET d.id = $newIdBase + substring(d.id, size(oldIdBase))
                    RETURN count(d)
                `;
                await this.runQuery(updateQuery, { oldId, newId, newChildNumber, oldIdBase: oldId, newIdBase: newId });
                alert('Child Number and all descendant IDs updated successfully!');
                this.refreshCurrentView();
            },
            
            async saveProperty(personId, property, value) {
                // This is called from inline edit, which already has edit mode check in bindEvents
                const query = `MATCH (p:Person {id: $id}) SET p.${property} = $value`;
                await this.runQuery(query, { id: personId, value: value });
                alert(`${property} updated successfully!`);
                this.refreshCurrentView();
            },


            // --- Form Logic ---
            async openForm({ type, relatedId, genNumber, title, initialData = {}, context = {} }) {
                const schemaQuery = "MATCH (s:Schema {id: 'person_schema'}) RETURN s.keys as keys, s.mandatory_keys as mandatory";
                const schemaResult = await this.runQuery(schemaQuery);
                if (schemaResult.length === 0) {
                    alert("Schema not found in database!");
                    return;
                }
                const schema = schemaResult[0].keys;
                const mandatoryKeys = schemaResult[0].mandatory || [];

                this.ui.modal.title.textContent = title;
                this.ui.modal.form.innerHTML = ''; // Clear previous form
                
                if (type === 'spouse') {
                    this.ui.modal.form.innerHTML = `
                        <div class="flex items-center">
                            <input id="existing-spouse-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="existing-spouse-checkbox" class="ml-2 block text-base text-gray-900">Is spouse an existing person?</label>
                        </div>
                        <div id="link-spouse-form" class="hidden space-y-2 pt-2">
                             <p class="text-sm text-gray-500">If the person doesn't exist yet, please add them to the tree first, then link them here.</p>
                             <input type="text" id="existing-spouse-id" placeholder="Enter existing person's ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div id="new-spouse-form" class="space-y-4"></div>
                    `;
                    
                    const newSpouseForm = this.ui.modal.form.querySelector('#new-spouse-form');
                    
                    const genField = `<div><label class="block text-base font-medium">genNumber</label><input type="text" data-key="genNumber" value="${genNumber}" disabled class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300"></div>`;
                    newSpouseForm.insertAdjacentHTML('beforeend', genField);

                    schema.forEach(key => {
                        if (key === 'genNumber' || key === 'childNumber') return;
                        const isMandatory = mandatoryKeys.includes(key);
                        const label = `${key}${isMandatory ? '*' : ''}`;
                        const value = initialData[key] || '';
                        this.createFormField(newSpouseForm, key, label, value);
                    });

                    const checkbox = this.ui.modal.form.querySelector('#existing-spouse-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        document.getElementById('new-spouse-form').classList.toggle('hidden', e.target.checked);
                        document.getElementById('link-spouse-form').classList.toggle('hidden', !e.target.checked);
                    });

                } else {
                    if (type === 'modify' && initialData.parentNames && initialData.parentNames.length > 0) {
                        const parentNamesString = initialData.parentNames.join(', ');
                        const quickInfoHTML = `
                            <div class="mb-4 p-3 bg-gray-50 rounded-md border text-base text-gray-600">
                                <strong>Parents:</strong> ${parentNamesString}
                            </div>
                        `;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', quickInfoHTML);
                    }

                    if (type !== 'modify') {
                        const genField = `<div><label class="block text-base font-medium">genNumber</label><input type="text" data-key="genNumber" value="${genNumber}" disabled class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300"></div>`;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', genField);
                    }
                    
                    // Logic for adding a child, including existing spouse selection for the PARENT
                    if (type === 'child') {
                        // Existing spouse selection dropdown for the PARENT
                        let parentSpouseOptionsHTML = '';
                        if (context.spouses && context.spouses.length > 0) {
                            parentSpouseOptionsHTML = `
                                <div id="parent-existing-spouse-section" class="mb-4">
                                    <label class="block text-base font-medium">Other Parent (Existing Spouse of ${relatedId})</label>
                                    <select id="parent-spouse-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option value="">-- Select an existing spouse --</option>
                                        ${context.spouses.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
                                    </select>
                                </div>
                            `;
                        }
                        this.ui.modal.form.insertAdjacentHTML('beforeend', parentSpouseOptionsHTML);

                        // General schema fields for the main person (child)
                        schema.forEach(key => {
                            if (key === 'genNumber' || key === 'childNumber') return; // genNumber handled above, childNumber handled below
                            const isMandatory = mandatoryKeys.includes(key);
                            const label = `${key}${isMandatory ? '*' : ''}`;
                            const value = initialData[key] || '';
                            this.createFormField(this.ui.modal.form, key, label, value);
                        });

                        // Child Number field
                        const childNumberField = `<div><label class="block text-base font-medium">childNumber*</label><input type="number" data-key="childNumber" class="mt-1 block w-full rounded-md border-gray-300"></div>`;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', childNumberField);

                        // Section for adding new spouse(s) for the CHILD - MOVED TO END
                        const childSpouseSectionHTML = `
                            <div class="border-t pt-4 mt-4">
                                <label class="block text-base font-medium text-gray-700 mb-2">Child's Spouse(s)</label>
                                <div id="child-spouses-container" class="space-y-3">
                                    <!-- New spouse fields will be dynamically added here -->
                                </div>
                                <button type="button" id="add-child-spouse-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Add Child's Spouse</button>
                            </div>
                        `;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', childSpouseSectionHTML);

                        const addChildSpouseBtn = this.ui.modal.form.querySelector('#add-child-spouse-btn');
                        const childSpousesContainer = this.ui.modal.form.querySelector('#child-spouses-container');

                        const addChildSpouseFields = () => {
                            const spouseFieldsHtml = `
                                <div class="flex flex-col sm:flex-row sm:items-end gap-2 p-3 border rounded-md bg-gray-50" data-child-spouse-entry>
                                    <div class="flex-grow">
                                        <label class="block text-sm font-medium">First Name*</label>
                                        <input type="text" data-key="childSpouseFirstName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div class="flex-grow">
                                        <label class="block text-sm font-medium">Last Name</label>
                                        <input type="text" data-key="childSpouseLastName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Gender*</label>
                                        <select data-key="childSpouseGender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                            <option value=""></option>
                                            <option value="M">M</option>
                                            <option value="F">F</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-2 rounded-md self-center sm:self-end remove-child-spouse-btn">Remove</button>
                                </div>
                            `;
                            childSpousesContainer.insertAdjacentHTML('beforeend', spouseFieldsHtml);
                        };

                        addChildSpouseBtn.addEventListener('click', addChildSpouseFields);
                        childSpousesContainer.addEventListener('click', (e) => {
                            if (e.target.classList.contains('remove-child-spouse-btn')) {
                                e.target.closest('[data-child-spouse-entry]').remove();
                            }
                        });
                    } else { // For add new person (top-level) or add sibling
                        // General schema fields for the main person (sibling or new top-level)
                        schema.forEach(key => {
                            if (key === 'genNumber' && type !== 'modify') return;
                            const isMandatory = mandatoryKeys.includes(key);
                            const label = `${key}${isMandatory ? '*' : ''}`;
                            const value = initialData[key] || '';
                            this.createFormField(this.ui.modal.form, key, label, value);
                        });
                    }

                    if (type === 'modify') {
                        const parentSectionHTML = `
                            <div class="border-t pt-4 mt-4">
                                <label class="block text-base font-medium text-gray-700 mb-2">Parents</label>
                                <div id="parents-list" class="space-y-2"></div>
                                <button type="button" id="add-parent-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Add Parent</button>
                            </div>
                        `;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', parentSectionHTML);

                        const actionsSectionHTML = `
                            <div class="border-t pt-4 mt-4">
                                <label class="block text-base font-medium text-gray-700 mb-2">Actions</label>
                                <button type="button" id="modal-view-children-btn" class="btn btn-secondary">View Children</button>
                            </div>
                        `;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', actionsSectionHTML);


                        const parentsListDiv = document.getElementById('parents-list');
                        const addParentBtn = document.getElementById('add-parent-btn');

                        const addParentField = (id = '') => {
                            const parentFieldHTML = `
                                <div class="flex items-center gap-2">
                                    <input type="text" value="${id}" placeholder="Enter Parent ID" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" data-parent-id>
                                    <button type="button" class="text-red-500 hover:text-red-700 remove-parent-btn">Remove</button>
                                </div>
                            `;
                            parentsListDiv.insertAdjacentHTML('beforeend', parentFieldHTML);
                        };

                        addParentBtn.addEventListener('click', () => addParentField());
                        parentsListDiv.addEventListener('click', (e) => {
                            if (e.target.classList.contains('remove-parent-btn')) {
                                e.target.closest('.flex').remove();
                            }
                        });

                        (initialData.parents || []).forEach(id => addParentField(id));
                    }
                }


                this.ui.modal.container.classList.remove('hidden');
                setTimeout(() => this.ui.modal.container.style.opacity = 1, 10);

                const submitHandler = async () => {
                    // Collect main person's form data
                    const formData = {};
                    let newId = (type === 'modify') ? relatedId : null;
                    
                    this.ui.modal.form.querySelectorAll('[data-key]').forEach(input => {
                        const key = input.dataset.key;
                        // Skip spouse fields that are part of the child's spouse dynamic section
                        if (key && (key.startsWith('childSpouseFirstName') || key.startsWith('childSpouseLastName') || key.startsWith('childSpouseGender'))) {
                            return;
                        }

                        let value = input.value;
                        if ((key === 'genNumber' || key === 'childNumber') && value) {
                            formData[key] = parseInt(value, 10);
                        } else if (key) { // Ensure key exists before assigning
                            formData[key] = value;
                        }
                    });

                    // Handle new child's spouses
                    const newChildSpousesDetails = [];
                    if (type === 'child') {
                        const childSpouseEntries = document.querySelectorAll('#child-spouses-container [data-child-spouse-entry]');
                        for (const entry of childSpouseEntries) {
                            const spouseFirstName = entry.querySelector('[data-key="childSpouseFirstName"]').value.trim();
                            const spouseLastName = entry.querySelector('[data-key="childSpouseLastName"]').value.trim();
                            const spouseGender = entry.querySelector('[data-key="childSpouseGender"]').value.trim();

                            if (!spouseFirstName || !spouseGender) { // LastName is now optional
                                alert('Please provide First Name and Gender for all new child spouses, or remove incomplete entries.');
                                return;
                            }
                            newChildSpousesDetails.push({
                                firstName: spouseFirstName,
                                lastName: spouseLastName, // Can be empty
                                gender: spouseGender
                            });
                        }
                    }


                    if (type === 'modify') {
                        const oldId = relatedId;
                        const oldChildNumber = initialData.childNumber ? String(neo4j.integer.toString(initialData.childNumber)) : '';
                        const newChildNumber = formData.childNumber ? String(formData.childNumber) : '';

                        if (newChildNumber && oldChildNumber && newChildNumber !== oldChildNumber) {
                            const parentResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id LIMIT 1', { id: oldId });
                            if (parentResult.length > 0) {
                                const parentId = parentResult[0].id;
                                newId = `${parentId}_${newChildNumber}`;
                                
                                const existingNode = await this.runQuery('MATCH (p:Person {id: $id}) RETURN p', { id: newId });
                                if (existingNode.length > 0) {
                                    alert(`Error: A person with the new generated ID '${newId}' already exists. Please choose a different childNumber.`);
                                    return;
                                }
                            }
                        }
                        
                        const newParentIds = Array.from(this.ui.modal.form.querySelectorAll('[data-parent-id]'))
                            .map(input => (input.value || '').trim())
                            .filter(Boolean);
                        const uniqueParentIds = [...new Set(newParentIds)];

                        // Delete all old parent relationships first
                        await this.runQuery(`MATCH (c:Person {id: $childId})-[r:CHILD_OF]->() DELETE r`, { childId: oldId });

                        // Create new ones from the unique list
                        if (uniqueParentIds.length > 0) {
                            await this.runQuery(`
                                MATCH (c:Person {id: $childId})
                                UNWIND $parentIds as parentId
                                MATCH (p:Person {id: parentId})
                                MERGE (c)-[:CHILD_OF]->(p)
                            `, { childId: oldId, parentIds: uniqueParentIds });
                        }
                        
                        const propsToSet = {};
                        const propsToRemove = [];
                        for (const key in formData) {
                            let initialVal = initialData[key];
                            if (neo4j.isInt(initialVal)) {
                                initialVal = initialVal.toNumber();
                            }
                            if (formData[key] !== (initialVal || '')) {
                                   if (formData[key] || formData[key] === 0) {
                                       propsToSet[key] = formData[key];
                                   } else {
                                       const isMandatory = mandatoryKeys.includes(key);
                                       if (!isMandatory) {
                                           propsToRemove.push(key);
                                       }
                                   }
                            }
                        }
                        if (newId !== oldId) {
                            propsToSet.id = newId;
                        }

                        let setClause = Object.keys(propsToSet).length > 0 ? "SET p += $propsToSet" : "";
                        let removeClause = propsToRemove.length > 0 ? "REMOVE " + propsToRemove.map(p => `p.\`${p}\``).join(', ') : "";

                        if (setClause || removeClause) {
                            await this.runQuery(`MATCH (p:Person {id: $oldId}) ${setClause} ${removeClause}`, { oldId: oldId, propsToSet: propsToSet });
                        }
                        
                    } else { // Logic for creating new person (child, sibling, spouse)
                        if (type === 'child' || type === 'sibling') {
                            const childNumber = formData.childNumber;
                            if (!childNumber) {
                                alert('childNumber is required to generate an ID.');
                                return;
                            }
                            let parentId = relatedId;
                            if (type === 'sibling') {
                                const parentResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id LIMIT 1', { id: relatedId });
                                if (parentResult.length === 0) {
                                    alert('Could not find parent to generate ID.');
                                    return;
                                }
                                parentId = parentResult[0].id;
                            }
                            newId = `${parentId}_${childNumber}`;
                        } else if (type === 'spouse') {
                            const spouseCountResult = await this.runQuery('MATCH (p:Person {id: $id})-[:SPOUSE_OF]-() RETURN count(*) as spouseCount', { id: relatedId });
                            const spouseIndex = (spouseCountResult[0]?.spouseCount.low || 0) + 1;
                            newId = `${relatedId}_sp${spouseIndex}`;
                        }

                        if (!newId) {
                            alert('A unique ID is required.');
                            return;
                        }

                        const props = Object.fromEntries(Object.entries(formData).filter(([k, v]) => v !== ''));
                        await this.runQuery('CREATE (p:Person {id: $id}) SET p += $props', { id: newId, props });
                        
                        // Handle new child's spouses
                        if (type === 'child' && newChildSpousesDetails.length > 0) {
                            let spouseCounter = 1;
                            for (const spouseDetail of newChildSpousesDetails) {
                                const newSpouseId = `${newId}_sp${spouseCounter++}`; // e.g., childID_sp1, childID_sp2
                                const spouseProps = {
                                    id: newSpouseId,
                                    firstName: spouseDetail.firstName,
                                    lastName: spouseDetail.lastName,
                                    gender: spouseDetail.gender,
                                    genNumber: formData.genNumber // Child's spouse is in the same generation as the child
                                };
                                await this.runQuery('CREATE (s:Person {id: $id}) SET s += $props', { id: newSpouseId, props: spouseProps });
                                await this.runQuery('MATCH (p1:Person {id: $p1Id}), (p2:Person {id: $p2Id}) MERGE (p1)-[:SPOUSE_OF]-(p2)', { p1Id: newId, p2Id: newSpouseId });
                            }
                        }

                        if (type === 'child') {
                            const parentIds = [relatedId]; // The person selected to add child to
                            const parentSpouseSelector = document.getElementById('parent-spouse-selector');
                            if (parentSpouseSelector && parentSpouseSelector.value) {
                                parentIds.push(parentSpouseSelector.value); // Add existing spouse of parent if selected
                            }
                            
                            for (const parentId of parentIds) {
                                await this.runQuery('MATCH (c:Person {id: $childId}), (p:Person {id: $parentId}) MERGE (c)-[:CHILD_OF]->(p)', { childId: newId, parentId: parentId });
                            }
                        } else if (type === 'sibling') {
                               const parents = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id', { id: relatedId });
                               for (const parent of parents) {
                                    await this.runQuery('MATCH (c:Person {id: $childId}), (p:Person {id: $parentId}) MERGE (c)-[:CHILD_OF]->(p)', { childId: newId, parentId: parent.id });
                               }
                        } else if (type === 'spouse') {
                            // This path is for adding a spouse directly using the 'Add Spouse' button, not from 'Add Person' form
                            await this.runQuery('MATCH (p1:Person {id: $p1Id}), (p2:Person {id: $p2Id}) MERGE (p1)-[:SPOUSE_OF]-(p2)', { p1Id: newId, p2Id: relatedId });
                        }
                    }

                    alert('Operation successful!');
                    closeModal();
                    this.refreshCurrentView();
                };

                const closeModal = () => {
                    this.ui.modal.container.style.opacity = 0;
                    setTimeout(() => this.ui.modal.container.classList.add('hidden'), 250);
                    this.ui.modal.submit.removeEventListener('click', submitHandler);
                    this.ui.modal.cancel.removeEventListener('click', closeModal);
                };
                
                const modalViewChildrenBtn = document.getElementById('modal-view-children-btn');
                const modalViewChildrenHandler = () => {
                    closeModal();
                    this._loadView('children', relatedId, true);
                };
                if (modalViewChildrenBtn) {
                    modalViewChildrenBtn.addEventListener('click', modalViewChildrenHandler);
                }

                this.ui.modal.submit.addEventListener('click', submitHandler);
                this.ui.modal.cancel.addEventListener('click', closeModal);
            },
            
            createFormField(container, key, label, value) {
                let fieldHTML = '';
                if (key === 'dob' || key === 'dod') {
                    fieldHTML = `
                        <div>
                            <label class="block text-base font-medium">${label}</label>
                            <input type="text" data-key="${key}" value="${value}" placeholder="YYYY or YYYY-MM-DD" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>`;
                } else if (key === 'gender') {
                    fieldHTML = `
                        <div>
                            <label class="block text-base font-medium">${label}</label>
                            <select data-key="${key}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="" ${value === '' ? 'selected' : ''}></option>
                                <option value="M" ${value === 'M' ? 'selected' : ''}>M</option>
                                <option value="F" ${value === 'F' ? 'selected' : ''}>F</option>
                            </select>
                        </div>`;
                } else {
                    fieldHTML = `
                        <div>
                            <label class="block text-base font-medium">${label}</label>
                            <input type="text" data-key="${key}" value="${value}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>`;
                }
                container.insertAdjacentHTML('beforeend', fieldHTML);
            },
            
            async refreshCurrentView() {
                await this._loadView(this.viewMode, this.viewContextId, false);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>

