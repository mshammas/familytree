<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maliyakkal Family Tree</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Neo4j JavaScript Driver -->
    <script src="https://unpkg.com/neo4j-driver"></script>
    <style>
        /* Simple transition for modals and buttons */
        .modal {
            transition: opacity 0.25s ease;
        }
        .btn {
            @apply px-4 py-2 rounded-md font-semibold text-white shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400;
        }
        .btn-disabled {
            @apply bg-gray-300 cursor-not-allowed hover:scale-100;
        }
        /* Styles for the responsive table-to-card view */
        @media (max-width: 640px) {
            #person-list td:before {
                content: attr(data-label);
                font-weight: 600; /* semibold */
                width: 7rem; /* 112px */
                display: inline-block;
                color: #4b5563; /* gray-600 */
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="container mx-auto p-2 sm:p-4 max-w-4xl">

        <!-- Connection Screen -->
        <div id="connection-screen" class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Connect to Neo4j Database</h1>
                <div class="space-y-4">
                    <div>
                        <label for="uri" class="block text-sm font-medium text-gray-700">Database URI</label>
                        <input type="text" id="uri" value="neo4j+s://51ac777b.databases.neo4j.io" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="connect-btn" class="w-full btn btn-primary">Connect</button>
                </div>
            </div>
        </div>

        <!-- Main Application Screen (hidden by default) -->
        <div id="main-app" class="hidden">
            <header class="bg-white p-4 rounded-lg shadow-md mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Maliyakkal Family Tree</h1>
                <p id="current-selection-label" class="text-gray-600 italic mt-1">Current Selection: None</p>
            </header>

            <!-- Action Buttons -->
            <div class="bg-white p-3 rounded-lg shadow-md mb-4 flex flex-col sm:flex-row flex-wrap items-center gap-y-2">
                <!-- Primary Actions -->
                <div class="flex flex-row flex-wrap justify-center items-center">
                    <button id="add-child-btn" class="btn btn-primary btn-disabled mx-1" disabled>Add Child</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="add-sibling-btn" class="btn btn-primary btn-disabled mx-1" disabled>Add Sibling</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="add-spouse-btn" class="btn btn-primary btn-disabled mx-1" disabled>Add Spouse</button>
                </div>

                <!-- Contextual Actions -->
                <div class="flex flex-row flex-wrap justify-center items-center w-full sm:w-auto border-t sm:border-t-0 sm:border-l border-gray-200 pt-2 sm:pt-0 sm:pl-4">
                    <button id="modify-btn" class="btn btn-secondary btn-disabled mx-1" disabled>Modify Person</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="view-children-btn" class="btn btn-secondary btn-disabled mx-1" disabled>View Children</button>
                </div>

                <!-- Spacer -->
                <div class="flex-grow"></div>

                <!-- Navigation Actions -->
                <div class="flex flex-row flex-wrap justify-center items-center w-full sm:w-auto border-t sm:border-t-0 sm:border-l border-gray-200 pt-2 sm:pt-0 sm:pl-4">
                    <button id="back-btn" class="btn btn-secondary btn-disabled mx-1" disabled>Go Back</button>
                    <span class="text-gray-300 font-light">|</span>
                    <button id="top-gen-btn" class="btn btn-secondary mx-1">Go to Top Generation</button>
                </div>
            </div>

            <!-- Person List -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-50 hidden sm:table-header-group">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Birth</th>
                        </tr>
                    </thead>
                    <tbody id="person-list" class="bg-white">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Modal for Forms -->
    <div id="modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="opacity: 0;">
        <div class="relative top-10 sm:top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Add Person</h3>
                <div id="modal-form" class="mt-2 px-7 py-3 space-y-4 text-left">
                    <!-- Form fields will be inserted here by JavaScript -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-submit" class="btn btn-primary">Submit</button>
                    <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const App = {
            driver: null,
            dbName: 'neo4j', // AuraDB default
            currentPersonId: null,
            
            // --- State management for refreshing the view ---
            viewMode: 'generation',
            viewContextId: 1,
            viewHistory: [],
            
            // --- Initialization ---
            init() {
                this.cacheElements();
                this.bindEvents();
            },

            cacheElements() {
                this.ui = {
                    connectionScreen: document.getElementById('connection-screen'),
                    mainApp: document.getElementById('main-app'),
                    uriInput: document.getElementById('uri'),
                    passwordInput: document.getElementById('password'),
                    connectBtn: document.getElementById('connect-btn'),
                    selectionLabel: document.getElementById('current-selection-label'),
                    personList: document.getElementById('person-list'),
                    buttons: {
                        addChild: document.getElementById('add-child-btn'),
                        addSibling: document.getElementById('add-sibling-btn'),
                        addSpouse: document.getElementById('add-spouse-btn'),
                        modify: document.getElementById('modify-btn'),
                        viewChildren: document.getElementById('view-children-btn'),
                        back: document.getElementById('back-btn'),
                        topGen: document.getElementById('top-gen-btn'),
                    },
                    modal: {
                        container: document.getElementById('modal'),
                        title: document.getElementById('modal-title'),
                        form: document.getElementById('modal-form'),
                        submit: document.getElementById('modal-submit'),
                        cancel: document.getElementById('modal-cancel'),
                    }
                };
            },

            bindEvents() {
                this.ui.connectBtn.addEventListener('click', () => this.connect());
                this.ui.passwordInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.connect();
                });
                
                // Main app buttons
                this.ui.buttons.topGen.addEventListener('click', () => this.go_to_top_generation());
                this.ui.buttons.back.addEventListener('click', () => this.goBack());
                this.ui.buttons.viewChildren.addEventListener('click', () => this.viewChildren());

                // Action buttons that depend on selection
                this.ui.buttons.addChild.addEventListener('click', () => this.addChild());
                this.ui.buttons.addSibling.addEventListener('click', () => this.addSibling());
                this.ui.buttons.addSpouse.addEventListener('click', () => this.addSpouse());
                this.ui.buttons.modify.addEventListener('click', () => this.modifyPerson());
            },

            // --- Connection Logic ---
            async connect() {
                const uri = this.ui.uriInput.value;
                const password = this.ui.passwordInput.value;
                const user = 'neo4j';

                if (!uri || !password) {
                    alert('Please provide both URI and password.');
                    return;
                }

                this.ui.connectBtn.textContent = 'Connecting...';
                this.ui.connectBtn.disabled = true;

                try {
                    this.driver = neo4j.driver(uri, neo4j.auth.basic(user, password));
                    await this.driver.verifyConnectivity();
                    
                    this.ui.connectionScreen.classList.add('hidden');
                    this.ui.mainApp.classList.remove('hidden');
                    this.go_to_top_generation();

                } catch (error) {
                    console.error('Connection Error:', error);
                    alert(`Connection failed: ${error.message}`);
                } finally {
                    this.ui.connectBtn.textContent = 'Connect';
                    this.ui.connectBtn.disabled = false;
                }
            },

            // --- Data Fetching & Display ---
            async runQuery(query, params = {}) {
                if (!this.driver) return [];
                const session = this.driver.session({ database: this.dbName });
                try {
                    const result = await session.run(query, params);
                    return result.records.map(record => record.toObject());
                } catch (error) {
                    console.error('Query Error:', error);
                    alert(`A database error occurred: ${error.message}`);
                    return [];
                } finally {
                    await session.close();
                }
            },
            
            // --- View Loading Logic ---
            async _loadView(mode, contextId, addToHistory) {
                if (addToHistory) {
                    this.viewHistory.push({ mode: this.viewMode, contextId: this.viewContextId });
                }

                this.viewMode = mode;
                this.viewContextId = contextId;

                if (mode === 'children') {
                    await this._displayChildrenInternal(contextId);
                } else {
                    await this._displayTopGenInternal();
                }

                this.ui.buttons.back.disabled = this.viewHistory.length === 0;
            },

            async _displayTopGenInternal() {
                this.ui.selectionLabel.textContent = 'Displaying Top Generation';
                // FIXED QUERY: Robustly finds and sorts top generation members and their spouses without duplication.
                const query = `
                    CALL {
                        MATCH (p:Person) WHERE toInteger(p.genNumber) = 1
                        OPTIONAL MATCH (p)-[:SPOUSE_OF]-(s:Person) WHERE toInteger(s.genNumber) = 1
                        WITH p, s WHERE s IS NULL OR id(p) < id(s)
                        RETURN p as person, '' as indicator, p.id as sortKey, 0 as isSpouse
                        UNION
                        MATCH (p:Person)-[:SPOUSE_OF]-(s:Person) WHERE toInteger(p.genNumber) = 1 AND toInteger(s.genNumber) = 1 AND id(p) > id(s)
                        RETURN p as person, '(Spouse of ' + s.firstName + ')' as indicator, s.id as sortKey, 1 as isSpouse
                    }
                    RETURN person.id as id,
                           trim(coalesce(person.firstName, '') + ' ' + coalesce(person.lastName, '')) AS name,
                           coalesce(person.dob, 'Not Set') AS dob,
                           indicator
                    ORDER BY sortKey, isSpouse
                `;
                const people = await this.runQuery(query);
                this.renderPersonList(people);
            },

            async _displayChildrenInternal(parentId) {
                const parentNameResult = await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.firstName as name', { id: parentId });
                const parentName = parentNameResult.length > 0 ? parentNameResult[0].name : parentId;
                this.ui.selectionLabel.textContent = `Children of: ${parentName}`;
                
                // FIXED QUERY: Prevents duplication of spouses who are also children.
                const query = `
                    CALL {
                        MATCH (parent:Person {id: $parentId})<-[:CHILD_OF]-(child:Person)
                        RETURN child AS person, '' AS indicator, child.id AS sortKey, 0 as isSpouse, null as parentId
                        UNION
                        MATCH (parent:Person {id: $parentId})<-[:CHILD_OF]-(child:Person)-[:SPOUSE_OF]-(spouse:Person)
                        WHERE NOT (spouse)-[:CHILD_OF]->(parent)
                        WITH DISTINCT spouse, child
                        OPTIONAL MATCH (spouse)-[:CHILD_OF]->(spouseParent:Person)
                        WITH spouse, child, collect(spouseParent.id)[0] as firstParentId
                        RETURN spouse AS person, '(Spouse of ' + child.firstName + ')' AS indicator, child.id AS sortKey, 1 as isSpouse, firstParentId as parentId
                    }
                    RETURN person.id as id,
                           trim(coalesce(person.firstName, '') + ' ' + coalesce(person.lastName, '')) AS name,
                           coalesce(person.dob, 'Not Set') AS dob,
                           indicator,
                           parentId
                    ORDER BY sortKey, isSpouse
                `;
                const childrenAndSpouses = await this.runQuery(query, { parentId });
                this.renderPersonList(childrenAndSpouses);
            },

            renderPersonList(people) {
                this.ui.personList.innerHTML = '';
                this.resetButtons();

                if (people.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3" class="block sm:table-cell px-6 py-4 text-center text-gray-500">No people found.</td>`;
                    this.ui.personList.appendChild(row);
                } else {
                    people.forEach(person => {
                        const row = document.createElement('tr');
                        row.className = 'block sm:table-row border-b sm:border-none mb-2 sm:mb-0 cursor-pointer hover:bg-gray-50';
                        
                        let indicatorHTML = '';
                        if (person.indicator) {
                            if (person.parentId) {
                                indicatorHTML = `<span class="text-xs text-gray-400 italic ml-2">${person.indicator} <a href="#" data-parent-id="${person.parentId}" class="text-blue-500 hover:underline view-parents-link">(view parents)</a></span>`;
                            } else {
                                indicatorHTML = `<span class="text-xs text-gray-400 italic ml-2">${person.indicator}</span>`;
                            }
                        }

                        row.innerHTML = `
                            <td data-label="ID:" class="block sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-sm font-medium text-gray-900">${person.id}</td>
                            <td data-label="Name:" class="block sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">${person.name} ${indicatorHTML}</td>
                            <td data-label="DOB:" class="block sm:table-cell px-6 py-2 sm:py-4 whitespace-nowrap text-sm text-gray-500">${person.dob}</td>
                        `;
                        row.addEventListener('click', (e) => {
                            if (e.target.classList.contains('view-parents-link')) {
                                e.stopPropagation();
                                const parentId = e.target.dataset.parentId;
                                this._loadView('children', parentId, true);
                                return;
                            }
                            document.querySelectorAll('#person-list tr').forEach(r => r.classList.remove('bg-blue-100'));
                            row.classList.add('bg-blue-100');
                            this.onPersonSelect(person.id, person.name);
                        });
                        row.addEventListener('dblclick', (e) => {
                             if (!e.target.classList.contains('view-parents-link')) {
                                this.viewChildren();
                             }
                        });
                        this.ui.personList.appendChild(row);
                    });
                }

                if (this.viewMode === 'children') {
                    this.currentPersonId = this.viewContextId; // Set active person to the parent
                    this.ui.buttons.addChild.disabled = false;
                    this.ui.buttons.addChild.classList.remove('btn-disabled');
                    this.ui.buttons.addSpouse.disabled = false;
                    this.ui.buttons.addSpouse.classList.remove('btn-disabled');
                    this.ui.selectionLabel.textContent += `. Actions apply to parent.`;
                }
            },

            // --- UI State & Event Handlers ---
            onPersonSelect(id, name) {
                this.currentPersonId = id;
                this.ui.selectionLabel.textContent = `Selected: ${name} (ID: ${id})`;
                Object.values(this.ui.buttons).forEach(btn => {
                    if (btn.id !== 'back-btn' && btn.id !== 'top-gen-btn') {
                        btn.disabled = false;
                        btn.classList.remove('btn-disabled');
                    }
                });
            },

            resetButtons() {
                this.currentPersonId = null;
                Object.values(this.ui.buttons).forEach(btn => {
                     if (btn.id !== 'back-btn' && btn.id !== 'top-gen-btn') {
                        btn.disabled = true;
                        btn.classList.add('btn-disabled');
                    }
                });
            },
            
            async goBack() {
                if (this.viewHistory.length === 0) return;
                const previousView = this.viewHistory.pop();
                await this._loadView(previousView.mode, previousView.contextId, false);
            },
            
            go_to_top_generation() {
                this.viewHistory = [];
                this._loadView('generation', 1, false);
            },
            
            viewChildren() {
                if (!this.currentPersonId) return;
                this._loadView('children', this.currentPersonId, true);
            },

            // --- Actions (Add, Modify, etc.) ---
            async addChild() {
                if (!this.currentPersonId) return;
                const parent = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.genNumber as gen', { id: this.currentPersonId }))[0];
                const parentGen = parent ? parseInt(parent.gen, 10) : 1;
                
                const spouses = await this.runQuery('MATCH (p:Person {id: $id})-[:SPOUSE_OF]-(s:Person) RETURN s.id as id, s.firstName as name', { id: this.currentPersonId });

                this.openForm({
                    type: 'child',
                    relatedId: this.currentPersonId,
                    genNumber: parentGen + 1,
                    title: 'Add New Child',
                    context: { spouses }
                });
            },
            
            async addSibling() {
                if (!this.currentPersonId) return;
                const sibling = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.genNumber as gen', { id: this.currentPersonId }))[0];
                if (!sibling) {
                    alert("Cannot add sibling to a person with no generation number.");
                    return;
                }
                this.openForm({
                    type: 'sibling',
                    relatedId: this.currentPersonId,
                    genNumber: parseInt(sibling.gen, 10),
                    title: 'Add New Sibling'
                });
            },
            
            async addSpouse() {
                if (!this.currentPersonId) return;
                const person = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p.genNumber as gen', { id: this.currentPersonId }))[0];
                const personGen = person ? parseInt(person.gen, 10) : 1;
                this.openForm({
                    type: 'spouse',
                    relatedId: this.currentPersonId,
                    genNumber: personGen,
                    title: 'Add New Spouse'
                });
            },

            async modifyPerson() {
                if (!this.currentPersonId) return;
                const personDataResult = (await this.runQuery('MATCH (p:Person {id: $id}) RETURN p', { id: this.currentPersonId }))[0];
                const personData = personDataResult.p.properties;

                const parentsResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN collect(p.id) as parentIds', { id: this.currentPersonId });
                personData.parents = parentsResult.length > 0 ? parentsResult[0].parentIds : [];

                this.openForm({
                    type: 'modify',
                    relatedId: this.currentPersonId,
                    initialData: personData,
                    title: 'Modify Person'
                });
            },

            // --- Form Logic ---
            async openForm({ type, relatedId, genNumber, title, initialData = {}, context = {} }) {
                const schemaQuery = "MATCH (s:Schema {id: 'person_schema'}) RETURN s.keys as keys, s.mandatory_keys as mandatory";
                const schemaResult = await this.runQuery(schemaQuery);
                if (schemaResult.length === 0) {
                    alert("Schema not found in database!");
                    return;
                }
                const schema = schemaResult[0].keys;
                const mandatoryKeys = schemaResult[0].mandatory || [];

                this.ui.modal.title.textContent = title;
                this.ui.modal.form.innerHTML = ''; // Clear previous form
                
                if (type === 'spouse') {
                    this.ui.modal.form.innerHTML = `
                        <div class="flex items-center">
                            <input id="existing-spouse-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="existing-spouse-checkbox" class="ml-2 block text-sm text-gray-900">Is spouse an existing person?</label>
                        </div>
                        <div id="link-spouse-form" class="hidden space-y-2 pt-2">
                             <p class="text-xs text-gray-500">If the person doesn't exist yet, please add them to the tree first, then link them here.</p>
                             <input type="text" id="existing-spouse-id" placeholder="Enter existing person's ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div id="new-spouse-form" class="space-y-4"></div>
                    `;
                    
                    const newSpouseForm = this.ui.modal.form.querySelector('#new-spouse-form');
                    
                    const genField = `<div><label class="block text-sm font-medium">genNumber</label><input type="text" data-key="genNumber" value="${genNumber}" disabled class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300"></div>`;
                    newSpouseForm.insertAdjacentHTML('beforeend', genField);

                    schema.forEach(key => {
                        if (key === 'genNumber' || key === 'childNumber') return;
                        const isMandatory = mandatoryKeys.includes(key);
                        const label = `${key}${isMandatory ? '*' : ''}`;
                        const value = initialData[key] || '';
                        this.createFormField(newSpouseForm, key, label, value);
                    });

                    const checkbox = this.ui.modal.form.querySelector('#existing-spouse-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        document.getElementById('new-spouse-form').classList.toggle('hidden', e.target.checked);
                        document.getElementById('link-spouse-form').classList.toggle('hidden', !e.target.checked);
                    });

                } else {
                    if (type !== 'modify') {
                        const genField = `<div><label class="block text-sm font-medium">genNumber</label><input type="text" data-key="genNumber" value="${genNumber}" disabled class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300"></div>`;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', genField);
                    }
                    
                    if (type === 'child' && context.spouses && context.spouses.length > 0) {
                        let spouseOptions = context.spouses.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
                        const spouseSelectorHTML = `
                            <div>
                                <label class="block text-sm font-medium">Other Parent (Spouse)*</label>
                                <select id="spouse-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    ${spouseOptions}
                                </select>
                            </div>
                        `;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', spouseSelectorHTML);
                    }

                    schema.forEach(key => {
                        if (key === 'genNumber' && type !== 'modify') return;
                        const isMandatory = mandatoryKeys.includes(key);
                        const label = `${key}${isMandatory ? '*' : ''}`;
                        const value = initialData[key] || '';
                        this.createFormField(this.ui.modal.form, key, label, value);
                    });

                    if (type === 'modify') {
                        const parentSectionHTML = `
                            <div class="border-t pt-4 mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Parents</label>
                                <div id="parents-list" class="space-y-2"></div>
                                <button type="button" id="add-parent-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Add Parent</button>
                            </div>
                        `;
                        this.ui.modal.form.insertAdjacentHTML('beforeend', parentSectionHTML);

                        const parentsListDiv = document.getElementById('parents-list');
                        const addParentBtn = document.getElementById('add-parent-btn');

                        const addParentField = (id = '') => {
                            const parentFieldHTML = `
                                <div class="flex items-center gap-2">
                                    <input type="text" value="${id}" placeholder="Enter Parent ID" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm" data-parent-id>
                                    <button type="button" class="text-red-500 hover:text-red-700 remove-parent-btn">Remove</button>
                                </div>
                            `;
                            parentsListDiv.insertAdjacentHTML('beforeend', parentFieldHTML);
                        };

                        addParentBtn.addEventListener('click', () => addParentField());
                        parentsListDiv.addEventListener('click', (e) => {
                            if (e.target.classList.contains('remove-parent-btn')) {
                                e.target.closest('.flex').remove();
                            }
                        });

                        (initialData.parents || []).forEach(id => addParentField(id));
                    }
                }


                this.ui.modal.container.classList.remove('hidden');
                setTimeout(() => this.ui.modal.container.style.opacity = 1, 10);

                const submitHandler = async () => {
                    const isExistingSpouse = document.getElementById('existing-spouse-checkbox')?.checked;
                    if (isExistingSpouse) {
                        const existingSpouseId = document.getElementById('existing-spouse-id').value;
                        if (!existingSpouseId) {
                            alert('Please enter the ID of the existing spouse.');
                            return;
                        }
                        await this.runQuery('MATCH (p1:Person {id: $p1Id}), (p2:Person {id: $p2Id}) MERGE (p1)-[:SPOUSE_OF]-(p2)', { p1Id: relatedId, p2Id: existingSpouseId });
                        alert('Spouses linked successfully!');
                        closeModal();
                        this.refreshCurrentView();
                        return;
                    }

                    const formData = {};
                    let newId = (type === 'modify') ? relatedId : null;
                    
                    this.ui.modal.form.querySelectorAll('[data-key], input:disabled[value]').forEach(input => {
                        const key = input.dataset.key || 'genNumber';
                        let value = input.value;

                        if ((key === 'genNumber' || key === 'childNumber') && value) {
                            formData[key] = parseInt(value, 10);
                        } else {
                            formData[key] = value;
                        }
                    });

                    if (type === 'modify') {
                        const oldId = relatedId;
                        const oldChildNumber = initialData.childNumber || '';
                        const newChildNumber = formData.childNumber || '';

                        if (newChildNumber && newChildNumber !== oldChildNumber) {
                            const parentResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id LIMIT 1', { id: oldId });
                            if (parentResult.length > 0) {
                                const parentId = parentResult[0].id;
                                newId = `${parentId}_${newChildNumber}`;
                                
                                const existingNode = await this.runQuery('MATCH (p:Person {id: $id}) RETURN p', { id: newId });
                                if (existingNode.length > 0) {
                                    alert(`Error: A person with the new generated ID '${newId}' already exists. Please choose a different childNumber.`);
                                    return;
                                }
                            }
                        }

                        const initialParentIds = initialData.parents || [];
                        const newParentIds = Array.from(document.querySelectorAll('[data-parent-id]')).map(input => input.value).filter(Boolean);
                        const parentsToAdd = newParentIds.filter(id => !initialParentIds.includes(id));
                        const parentsToRemove = initialParentIds.filter(id => !newParentIds.includes(id));

                        if (parentsToAdd.length > 0) {
                            await this.runQuery(`MATCH (c:Person {id: $childId}), (p:Person) WHERE p.id IN $parentIds MERGE (c)-[:CHILD_OF]->(p)`, { childId: oldId, parentIds: parentsToAdd });
                        }
                        if (parentsToRemove.length > 0) {
                            await this.runQuery(`MATCH (c:Person {id: $childId})-[r:CHILD_OF]->(p:Person) WHERE p.id IN $parentIds DELETE r`, { childId: oldId, parentIds: parentsToRemove });
                        }
                        
                        const propsToSet = {};
                        const propsToRemove = [];
                        for (const key in formData) {
                            if (formData[key] !== (initialData[key] || '')) {
                                 if (formData[key]) {
                                     propsToSet[key] = formData[key];
                                 } else {
                                     const isMandatory = mandatoryKeys.includes(key);
                                     if (!isMandatory) {
                                         propsToRemove.push(key);
                                     }
                                 }
                            }
                        }
                        if (newId !== oldId) {
                            propsToSet.id = newId;
                        }

                        let setClause = Object.keys(propsToSet).length > 0 ? "SET p += $propsToSet" : "";
                        let removeClause = propsToRemove.length > 0 ? "REMOVE " + propsToRemove.map(p => `p.\`${p}\``).join(', ') : "";

                        if (setClause || removeClause) {
                            await this.runQuery(`MATCH (p:Person {id: $oldId}) ${setClause} ${removeClause}`, { oldId: oldId, propsToSet: propsToSet });
                        }
                        
                    } else { // Logic for creating new person
                        if (type === 'child' || type === 'sibling') {
                            const childNumber = formData.childNumber;
                            if (!childNumber) {
                                alert('childNumber is required to generate an ID.');
                                return;
                            }
                            let parentId = relatedId;
                            if (type === 'sibling') {
                                const parentResult = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id LIMIT 1', { id: relatedId });
                                if (parentResult.length === 0) {
                                    alert('Could not find parent to generate ID.');
                                    return;
                                }
                                parentId = parentResult[0].id;
                            }
                            newId = `${parentId}_${childNumber}`;
                        } else if (type === 'spouse') {
                            const spouseCountResult = await this.runQuery('MATCH (p:Person {id: $id})-[:SPOUSE_OF]-() RETURN count(*) as spouseCount', { id: relatedId });
                            const spouseIndex = (spouseCountResult[0]?.spouseCount.low || 0) + 1;
                            newId = `${relatedId}_sp${spouseIndex}`;
                        }

                        if (!newId) {
                            alert('A unique ID is required.');
                            return;
                        }

                        const props = Object.fromEntries(Object.entries(formData).filter(([_, v]) => v !== ''));
                        await this.runQuery('CREATE (p:Person {id: $id}) SET p += $props', { id: newId, props });
                        
                        if (type === 'child') {
                            const parentIds = [relatedId];
                            const spouseSelector = document.getElementById('spouse-selector');
                            if (spouseSelector && spouseSelector.value) {
                                parentIds.push(spouseSelector.value);
                            }
                            for (const parentId of parentIds) {
                                await this.runQuery('MATCH (c:Person {id: $childId}), (p:Person {id: $parentId}) MERGE (c)-[:CHILD_OF]->(p)', { childId: newId, parentId: parentId });
                            }
                        } else if (type === 'sibling') {
                             const parents = await this.runQuery('MATCH (:Person {id: $id})-[:CHILD_OF]->(p:Person) RETURN p.id as id', { id: relatedId });
                             for (const parent of parents) {
                                await this.runQuery('MATCH (c:Person {id: $childId}), (p:Person {id: $parentId}) MERGE (c)-[:CHILD_OF]->(p)', { childId: newId, parentId: parent.id });
                             }
                        } else if (type === 'spouse') {
                            await this.runQuery('MATCH (p1:Person {id: $p1Id}), (p2:Person {id: $p2Id}) MERGE (p1)-[:SPOUSE_OF]-(p2)', { p1Id: newId, p2Id: relatedId });
                        }
                    }

                    alert('Operation successful!');
                    closeModal();
                    this.refreshCurrentView();
                };

                const closeModal = () => {
                    this.ui.modal.container.style.opacity = 0;
                    setTimeout(() => this.ui.modal.container.classList.add('hidden'), 250);
                    this.ui.modal.submit.removeEventListener('click', submitHandler);
                    this.ui.modal.cancel.removeEventListener('click', closeModal);
                };

                this.ui.modal.submit.addEventListener('click', submitHandler);
                this.ui.modal.cancel.addEventListener('click', closeModal);
            },
            
            createFormField(container, key, label, value) {
                let fieldHTML = '';
                if (key === 'dob' || key === 'dod') {
                    fieldHTML = `
                        <div>
                            <label class="block text-sm font-medium">${label}</label>
                            <input type="date" data-key="${key}" value="${value}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>`;
                } else if (key === 'gender') {
                    fieldHTML = `
                        <div>
                            <label class="block text-sm font-medium">${label}</label>
                            <select data-key="${key}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="" ${value === '' ? 'selected' : ''}></option>
                                <option value="M" ${value === 'M' ? 'selected' : ''}>M</option>
                                <option value="F" ${value === 'F' ? 'selected' : ''}>F</option>
                            </select>
                        </div>`;
                } else {
                    fieldHTML = `
                        <div>
                            <label class="block text-sm font-medium">${label}</label>
                            <input type="text" data-key="${key}" value="${value}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>`;
                }
                container.insertAdjacentHTML('beforeend', fieldHTML);
            },
            
            async refreshCurrentView() {
                await this._loadView(this.viewMode, this.viewContextId, false);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>

